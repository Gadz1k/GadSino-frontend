<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Plinko - Gadsino</title>
    <link rel="icon" type="image/png" href="img/icon.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root {
            --bg-color: #1a1b26;
            --surface-color: #2a2c3d;
            --primary-color: #fbc531;
            --text-color: #f1f2f6;
            --peg-color: #5a5d7a;
            --ball-color: #f1f2f6;
        }
        body {
            font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color);
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        header {
            width: 100%; padding: 1em 2em; background: rgba(0,0,0,0.2);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; box-sizing: border-box;
        }
        .balance-display { font-size: 1.1em; font-weight: 600; }
        .balance-display span { color: var(--primary-color); }
        .btn-back {
            color: var(--text-color); text-decoration: none; background: #333; padding: 0.5em 1em;
            border-radius: 8px; font-weight: 600; transition: background 0.2s;
        }
        .btn-back:hover { background: #444; }

        .game-container {
            display: flex; flex-direction: column; align-items: center;
            gap: 1.5em; padding: 2em; width: 100%; max-width: 800px;
        }

        .controls {
            display: flex; gap: 1em; width: 100%; max-width: 500px;
            padding: 1em; background: var(--surface-color); border-radius: 12px;
        }
        .bet-input {
            flex-grow: 1; padding: 0.8em; background: #333; border: 1px solid #444;
            border-radius: 8px; color: var(--text-color); font-size: 1.2rem;
        }
        .btn-drop {
            padding: 0 2em; font-size: 1.2rem; font-weight: 600; border: none;
            border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
            background: var(--primary-color); color: #121212;
        }
        .btn-drop:disabled { background: #555; color: #999; cursor: not-allowed; }

        .plinko-container { position: relative; }
        #plinko-board { overflow: visible; }
        
        /* --- KLUCZOWA POPRAWKA JEST TUTAJ --- */
        #ball {
            position: absolute;
            top: 0; /* Ustawia punkt odniesienia Y na g√≥rze kontenera */
            left: 0; /* Ustawia punkt odniesienia X na lewej krawƒôdzi kontenera */
            width: 16px; height: 16px;
            background: radial-gradient(circle at 5px 5px, #ffffff, var(--ball-color));
            border-radius: 50%;
            transition: transform 0.35s cubic-bezier(0.5, 0.2, 0.5, 0.8);
            box-shadow: 0 0 10px white;
            opacity: 0;
            transform-origin: center center;
            /* Usuniemy transform stƒÖd, bƒôdzie ustawiany tylko przez JS */
        }

        .multipliers {
            display: flex; justify-content: center;
            width: 100%; gap: 4px;
        }
        .multiplier-box {
            flex-grow: 1; text-align: center; padding: 0.8em 0.2em;
            background-color: var(--surface-color); border-radius: 8px;
            font-weight: 700; font-size: 1.1em; transition: all 0.3s;
        }
        .controls {
            flex-direction: column; /* Zmieniamy uk≈Çad na kolumnowy */
            width: 100%;
            max-width: 400px;
        }
        .mode-switcher {
            display: flex;
            background-color: #1a1b26;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 1em;
        }
        .mode-btn {
            flex: 1;
            padding: 0.8em;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-size: 1em;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .mode-btn.active {
            background-color: #3e415b;
        }
        .control-group {
            margin-bottom: 1em;
        }
        .control-group label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: 600;
            font-size: 0.9em;
            color: #aaa;
        }
        .control-group input, .control-group select {
            width: 100%;
            padding: 0.8em;
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1.1rem;
            box-sizing: border-box;
        }
        #auto-mode-panel.hidden {
            display: none;
        }
        .btn-drop.stop-autobet {
            background-color: #e74c3c; /* Czerwony kolor dla przycisku stop */
        }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="btn-back">‚Üê Powr√≥t do lobby</a>
    <h1>PLINKO</h1>
    <div class="balance-display">Saldo: <span id="user-balance">≈Åadowanie...</span></div>
</header>

<div class="game-container">
    <div class="controls">
        <div class="mode-switcher">
            <button id="manual-mode-btn" class="mode-btn active">Manual</button>
            <button id="auto-mode-btn" class="mode-btn">Auto</button>
        </div>
    
        <div class="control-group">
            <label for="bet-amount">Kwota zak≈Çadu</label>
            <input type="number" id="bet-amount" value="10">
        </div>
    
        <div id="auto-mode-panel" class="hidden">
            <div class="control-group">
                <label for="risk-level">Ryzyko</label>
                <select id="risk-level">
                    <option value="low">Niskie</option>
                    <option value="medium" selected>≈örednie</option>
                    <option value="high">Wysokie</option>
                </select>
            </div>
            <div class="control-group">
                <label for="row-count">Liczba rzƒôd√≥w</label>
                <select id="row-count">
                    <option value="8">8</option>
                    <option value="10">10</option>
                    <option value="12" selected>12</option>
                    <option value="14">14</option>
                    <option value="16">16</option>
                </select>
            </div>
            <div class="control-group">
                <label for="number-of-bets">Liczba gier</label>
                <input type="number" id="number-of-bets" value="10">
            </div>
        </div>
    
        <button id="drop-button" class="btn-drop">Zagraj</button>
    </div>

    <div class="plinko-container">
        <svg id="plinko-board" width="600" height="550"></svg>
        <div id="ball"></div>
    </div>
    
    <div class="multipliers" id="multipliers-container"></div>
</div>

<script>
    const username = localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')).username : null;
    let currentUserBalance = 0;

    const ROWS = 12;
    const MULTIPLIERS = [16, 9, 2, 1.4, 1.1, 1, 0.5, 1, 1.1, 1.4, 2, 9, 16];
    const PEG_RADIUS = 6;
    const START_X = 300;
    const START_Y = 40;
    const ROW_HEIGHT = 40;
    const PEG_H_SPACING = 50;
    const BALL_RADIUS = 8;

    const userBalanceSpan = document.getElementById('user-balance');
    const dropButton = document.getElementById('drop-button');
    const betAmountInput = document.getElementById('bet-amount');
    const board = document.getElementById('plinko-board');
    const ball = document.getElementById('ball');
    const multipliersContainer = document.getElementById('multipliers-container');

    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    async function fetchUserBalance() {
        if (!username) {
            userBalanceSpan.textContent = 'N/A';
            return;
        }
        try {
            const response = await fetch(`https://gadsino.onrender.com/api/users/player/${username}`);
            if (!response.ok) throw new Error('B≈ÇƒÖd serwera');
            const data = await response.json();
            currentUserBalance = data.balance;
            userBalanceSpan.textContent = `${currentUserBalance} ü™ô`;
        } catch (error) {
            console.error("B≈ÇƒÖd pobierania salda:", error);
            userBalanceSpan.textContent = 'B≈ÇƒÖd';
        }
    }

    function initializeBoard() {
        for (let row = 0; row < ROWS; row++) {
            const numPegsInRow = row + 1;
            for (let i = 0; i < numPegsInRow; i++) {
                const x = START_X + (i * PEG_H_SPACING) - (row * PEG_H_SPACING / 2);
                const y = START_Y + (row * ROW_HEIGHT);
                const peg = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                peg.setAttribute("cx", x);
                peg.setAttribute("cy", y);
                peg.setAttribute("r", PEG_RADIUS);
                peg.setAttribute("fill", "var(--peg-color)");
                board.appendChild(peg);
            }
        }
        MULTIPLIERS.forEach((m) => {
            const box = document.createElement('div');
            box.className = 'multiplier-box';
            box.textContent = `${m}x`;
            box.style.color = m < 1 ? '#aaa' : m < 5 ? 'white' : 'var(--primary-color)';
            multipliersContainer.appendChild(box);
        });
    }

    async function animateBall(path) {
        ball.style.transition = 'none';
        ball.style.transform = `translate(${START_X - BALL_RADIUS}px, ${START_Y - 30 - BALL_RADIUS}px)`;
        ball.style.opacity = 1;
        
        await sleep(100);
        ball.style.transition = 'transform 0.35s cubic-bezier(0.5, 0.2, 0.5, 0.8)';
        
        let horizontalOffset = 0;

        for (let row = 0; row < path.length; row++) {
            const direction = path[row];
            horizontalOffset += (direction === 0) ? -0.5 : 0.5;
            const x = START_X + (horizontalOffset * PEG_H_SPACING);
            const y = START_Y + ((row + 1) * ROW_HEIGHT);
            ball.style.transform = `translate(${x - BALL_RADIUS}px, ${y - BALL_RADIUS}px)`;
            await sleep(400);
        }
        
        const finalSlotIndex = path.filter(d => d === 1).length;
        const multiplierBox = multipliersContainer.children[finalSlotIndex];
        const multiplierBoxRect = multiplierBox.getBoundingClientRect();
        const containerRect = board.getBoundingClientRect();
        
        const finalX = multiplierBoxRect.left - containerRect.left + (multiplierBoxRect.width / 2);
        const finalY = board.height.baseVal.value + 10;
        
        ball.style.transform = `translate(${finalX - BALL_RADIUS}px, ${finalY}px)`;
        await sleep(400);
        
        multiplierBox.style.transform = 'scale(1.15)';
        multiplierBox.style.backgroundColor = 'var(--primary-color)';
        multiplierBox.style.color = '#121212';
        
        await sleep(2000);
        
        ball.style.opacity = 0;
        multiplierBox.style.transform = 'scale(1)';
        multiplierBox.style.backgroundColor = 'var(--surface-color)';
        multiplierBox.style.color = MULTIPLIERS[finalSlotIndex] < 1 ? '#aaa' : MULTIPLIERS[finalSlotIndex] < 5 ? 'white' : 'var(--primary-color)';
    }

    dropButton.addEventListener('click', async () => {
        if (!username) return alert("Musisz byƒá zalogowany, aby graƒá.");
        const bet = parseInt(betAmountInput.value);
        if (!bet || bet <= 0) return alert("Wpisz poprawnƒÖ kwotƒô.");
        if (bet > currentUserBalance) return alert("NiewystarczajƒÖce ≈õrodki.");

        dropButton.disabled = true;

        try {
            const response = await fetch('https://gadsino.onrender.com/api/games/plinko/drop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, bet })
            });
            if (!response.ok) {
                 const errorData = await response.json();
                 throw new Error(errorData.message || 'B≈ÇƒÖd odpowiedzi serwera');
            }
            const result = await response.json();
            currentUserBalance = result.newBalance;
            userBalanceSpan.textContent = `${currentUserBalance} ü™ô`;
            await animateBall(result.path);
        } catch (error) {
            alert(`WystƒÖpi≈Ç b≈ÇƒÖd podczas gry: ${error.message}`);
            console.error(error);
        }
        dropButton.disabled = false;
    });

    initializeBoard();
    fetchUserBalance();
</script>
</body>
</html>
